{% extends "base.html" %}
{% block title %}–î–æ–∫–ª–∞–¥: {{ report.title }} ‚Äî ProofText{% endblock %}

{% block content %}
<style>
  .highlight-fragment {
    background-color: #fff0c7;
    padding: 2px 4px;
    border-radius: 4px;
    transition: background-color 0.3s;
  }

  .reference-container {
    max-width: 800px;
    margin: 30px auto;
    padding: 30px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 28px rgba(0, 0, 0, 0.08);
    font-family: 'Segoe UI', sans-serif;
  }

  .reference-container h1 {
    font-size: 26px;
    margin-bottom: 15px;
    color: #333;
  }

  .reference-container p {
    font-size: 16px;
    margin-bottom: 10px;
  }

  .btn-pdf,
  .btn-back {
    display: inline-block;
    margin-top: 20px;
    background: #7e00ff;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.3s;
  }

  .btn-back {
    background: #555;
    margin-right: 15px;
  }

  .btn-back:hover {
    background: #333;
  }

  .btn-pdf:hover {
    background: #5d00c7;
  }

  .content-block {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    white-space: pre-wrap;
    line-height: 1.6;
  }

  .plagiarism-details {
    margin-top: 40px;
    padding: 20px;
    background-color: #f9f5ff;
    border: 1px solid #e0d9f7;
    border-radius: 12px;
  }

  .plagiarism-details h2 {
    font-size: 22px;
    margin-bottom: 15px;
    color: #6b2bc3;
  }

  .match-item {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #ddd;
  }

  .match-item p {
    margin: 5px 0;
  }

  .match-item a {
    color: #7e00ff;
    text-decoration: underline;
  }
</style>

<div class="reference-container">
  <h1>{{ report.title }}</h1>

  <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ report.author.email }}</p>
  <p><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong> {{ report.created_at|date:"d.m.Y H:i" }}</p>
  <p><strong>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</strong>
    {% if report.originality_percent is not None %}
      {{ report.originality_percent }}%
    {% else %}‚Äì{% endif %}
  </p>
  <p><strong>–ò–ò-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è:</strong>
    {% if report.ai_generated_percent is not None %}
      {{ report.ai_generated_percent }}%
    {% else %}‚Äì{% endif %}
  </p>

  <a href="{% url 'profile' %}" class="btn-back">‚Üê –ù–∞–∑–∞–¥</a>
  <a href="{% url 'generate_certificate' report.id %}" class="btn-pdf">üì• –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É (PDF)</a>

  <div class="content-block" id="report-content">
    {{ report.content|default:"–¢–µ–∫—Å—Ç –¥–æ–∫–ª–∞–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω."|escapejs }}
  </div>

  {% if plagiarism_details %}
    <div class="plagiarism-details">
      <h2>–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö</h2>
      {% for match in plagiarism_details %}
        <div class="match-item">
          <p><strong>–§—Ä–∞–≥–º–µ–Ω—Ç:</strong> {{ match.fragment|truncatechars:200 }}</p>
          <p>
            <strong>–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:</strong>
            <span style="
              color: {% if match.similarity_percent >= 85 %}#c40000
                     {% elif match.similarity_percent >= 70 %}#e68700
                     {% elif match.similarity_percent >= 50 %}#0073e6
                     {% else %}#2f9e44{% endif %};
              font-weight: bold;">
              {{ match.similarity_percent }}%
            </span>
          </p>
          <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> <a href="{{ match.url }}" target="_blank">{{ match.title }}</a></p>
          <p><em>–°–Ω–∏–ø–ø–µ—Ç:</em> {{ match.snippet|truncatechars:250 }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="margin-top: 30px;">–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const contentBlock = document.getElementById("report-content");
    let contentText = contentBlock.textContent;

    const fragments = {{ plagiarism_details|safe }};

    if (!Array.isArray(fragments)) return;

    const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    fragments.forEach(match => {
      const fragment = match.fragment.trim();
      if (!fragment || fragment.length < 10) return;

      const regex = new RegExp(escapeRegExp(fragment), "gi");
      contentText = contentText.replace(regex, match => `<span class="highlight-fragment">${match}</span>`);
    });

    contentBlock.innerHTML = contentText;
  });
</script>
{% endblock %}
